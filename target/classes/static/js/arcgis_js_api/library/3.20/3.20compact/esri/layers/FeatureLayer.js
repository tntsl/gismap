// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.20/esri/copyright.txt for details.
//>>built
require({cache:{"esri/tasks/QueryTask":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/_base/json dojo/has ../kernel ../request ../deferredUtils ../geometry/Extent ../geometry/normalizeUtils ./Task ./FeatureSet".split(" "),function(d,m,t,w,q,c,A,x,e,u,b,a,k){d=d(a,{declaredClass:"esri.tasks.QueryTask",_eventMap:{complete:["featureSet"],"execute-for-count-complete":["count"],"execute-for-ids-complete":["objectIds"],"execute-relationship-query-complete":["featureSets"]},
constructor:function(a,b){this._handler=m.hitch(this,this._handler);this._relationshipQueryHandler=m.hitch(this,this._relationshipQueryHandler);this._executeForIdsHandler=m.hitch(this,this._executeForIdsHandler);this._countHandler=m.hitch(this,this._countHandler);this._extentHandler=m.hitch(this,this._extentHandler);this.source=b&&b.source;this.gdbVersion=b&&b.gdbVersion;this.registerConnectEvents()},__msigns:[{n:"execute",c:4,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForIds",c:3,a:[{i:0,p:["geometry"]}],
e:2},{n:"executeForCount",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForExtent",c:3,a:[{i:0,p:["geometry"]}],e:2}],onComplete:function(){},onExecuteRelationshipQueryComplete:function(){},onExecuteForIdsComplete:function(){},onExecuteForCountComplete:function(){},onExecuteForExtentComplete:function(){},execute:function(a,b,f,g,k){var l=k.assembly;a=this._encode(m.mixin({},this._url.query,{f:"json"},a.toJson(l&&l[0])));var p=this._handler,v=this._errorHandler;this.source&&(l={source:this.source.toJson()},
a.layer=q.toJson(l));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return x({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,g){p(a,g,b,f,k.dfd)},error:function(a){v(a,f,k.dfd)},callbackSuffix:g},this.requestOptions)},executeRelationshipQuery:function(a,b,f){a=this._encode(m.mixin({},this._url.query,{f:"json"},a.toJson()));var g=this._relationshipQueryHandler,k=this._errorHandler;this.gdbVersion&&(a.gdbVersion=this.gdbVersion);var l=new w(e._dfdCanceller);l._pendingDfd=
x({url:this._url.path+"/queryRelatedRecords",content:a,callbackParamName:"callback",load:function(a,k){g(a,k,b,f,l)},error:function(a){k(a,f,l)}},this.requestOptions);return l},executeForIds:function(a,b,f,k){var g=k.assembly;a=this._encode(m.mixin({},this._url.query,{f:"json",returnIdsOnly:!0},a.toJson(g&&g[0])));var l=this._executeForIdsHandler,v=this._errorHandler;this.source&&(g={source:this.source.toJson()},a.layer=q.toJson(g));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return x({url:this._url.path+
"/query",content:a,callbackParamName:"callback",load:function(a,g){l(a,g,b,f,k.dfd)},error:function(a){v(a,f,k.dfd)}},this.requestOptions)},executeForCount:function(a,b,f,k){var g=k.assembly;a=this._encode(m.mixin({},this._url.query,{f:"json",returnIdsOnly:!0,returnCountOnly:!0},a.toJson(g&&g[0])));var l=this._countHandler,v=this._errorHandler;this.source&&(g={source:this.source.toJson()},a.layer=q.toJson(g));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return x({url:this._url.path+"/query",content:a,
callbackParamName:"callback",load:function(a,g){l(a,g,b,f,k.dfd)},error:function(a){v(a,f,k.dfd)}},this.requestOptions)},executeForExtent:function(a,b,f,k){var g=k.assembly;a=this._encode(m.mixin({},this._url.query,{f:"json",returnExtentOnly:!0,returnCountOnly:!0},a.toJson(g&&g[0])));var l=this._extentHandler,v=this._errorHandler;this.source&&(g={source:this.source.toJson()},a.layer=q.toJson(g));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return x({url:this._url.path+"/query",content:a,callbackParamName:"callback",
load:function(a,g){l(a,g,b,f,k.dfd)},error:function(a){v(a,f,k.dfd)}},this.requestOptions)},_handler:function(a,b,f,g,p){try{var l=new k(a);this._successHandler([l],"onComplete",f,p)}catch(z){this._errorHandler(z,g,p)}},_relationshipQueryHandler:function(a,b,f,g,p){try{var l=a.geometryType,v=a.spatialReference,e={};t.forEach(a.relatedRecordGroups,function(a){var b={};b.geometryType=l;b.spatialReference=v;b.features=a.relatedRecords;b=new k(b);if(null!=a.objectId)e[a.objectId]=b;else for(var f in a)a.hasOwnProperty(f)&&
"relatedRecords"!==f&&(e[a[f]]=b)});this._successHandler([e],"onExecuteRelationshipQueryComplete",f,p)}catch(F){this._errorHandler(F,g,p)}},_executeForIdsHandler:function(a,b,f,k,e){try{this._successHandler([a.objectIds],"onExecuteForIdsComplete",f,e)}catch(r){this._errorHandler(r,k,e)}},_countHandler:function(a,b,f,k,e){try{var g,l=a.features,v=a.objectIds;if(v)g=v.length;else{if(l)throw Error("Unable to perform query. Please check your parameters.");g=a.count}this._successHandler([g],"onExecuteForCountComplete",
f,e)}catch(F){this._errorHandler(F,k,e)}},_extentHandler:function(a,b,f,k,e){try{a.extent&&(a.extent=new u(a.extent)),this._successHandler([a],"onExecuteForExtentComplete",f,e)}catch(r){this._errorHandler(r,k,e)}}});b._createWrappers(d);c("extend-esri")&&m.setObject("tasks.QueryTask",d,A);return d})},"esri/tasks/Task":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has ../kernel ../deferredUtils ../urlUtils ../Evented".split(" "),function(d,m,t,w,q,c,A,x){d=d(x,{declaredClass:"esri.tasks._Task",
_eventMap:{error:["error"],complete:["result"]},constructor:function(e,c){e&&m.isString(e)&&(this._url=A.urlToObject(this.url=e));c&&c.requestOptions&&(this.requestOptions=c.requestOptions);this.normalization=!0;this._errorHandler=m.hitch(this,this._errorHandler);this.registerConnectEvents()},_useSSL:function(){var e=this._url,c=/^http:/i;this.url&&(this.url=this.url.replace(c,"https:"));e&&e.path&&(e.path=e.path.replace(c,"https:"))},_encode:function(e,c,b){var a,k,l={},v,f;for(v in e)if("declaredClass"!==
v&&(a=e[v],k=typeof a,null!==a&&void 0!==a&&"function"!==k))if(m.isArray(a))for(l[v]=[],f=a.length,k=0;k<f;k++)l[v][k]=this._encode(a[k]);else"object"===k?a.toJson&&(k=a.toJson(b&&b[v]),"esri.tasks.FeatureSet"===a.declaredClass&&k.spatialReference&&(k.sr=k.spatialReference,delete k.spatialReference),l[v]=c?k:t.toJson(k)):l[v]=a;return l},_successHandler:function(e,x,b,a){x&&this[x].apply(this,e);b&&b.apply(null,e);a&&c._resDfd(a,e)},_errorHandler:function(e,c,b){this.onError(e);c&&c(e);b&&b.errback(e)},
setNormalization:function(e){this.normalization=e},onError:function(){}});w("extend-esri")&&(q.Task=d);return d})},"esri/tasks/FeatureSet":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../graphic ../SpatialReference ../graphicsUtils ../geometry/jsonUtils ../symbols/jsonUtils".split(" "),function(d,m,t,w,q,c,A,x,e,u,b){d=d(null,{declaredClass:"esri.tasks.FeatureSet",constructor:function(a){if(a){m.mixin(this,a);var k=this.features,l=a.spatialReference,
e=u.getGeometryType(a.geometryType),l=this.spatialReference=new x(l);this.geometryType=a.geometryType;a.fields&&(this.fields=a.fields);t.forEach(k,function(a,g){var f=a.geometry&&a.geometry.spatialReference;k[g]=new A(e&&a.geometry?new e(a.geometry):null,a.symbol&&b.fromJson(a.symbol),a.attributes);k[g].geometry&&!f&&k[g].geometry.setSpatialReference(l)});this._hydrate()}else this.features=[]},displayFieldName:null,geometryType:null,spatialReference:null,fieldAliases:null,toJson:function(a){var b=
{};this.displayFieldName&&(b.displayFieldName=this.displayFieldName);this.fields&&(b.fields=this.fields);this.spatialReference?b.spatialReference=this.spatialReference.toJson():this.features[0]&&this.features[0].geometry&&(b.spatialReference=this.features[0].geometry.spatialReference.toJson());this.features[0]&&(this.features[0].geometry&&(b.geometryType=u.getJsonType(this.features[0].geometry)),b.features=e._encodeGraphics(this.features,a));b.exceededTransferLimit=this.exceededTransferLimit;b.transform=
this.transform;return c.fixJson(b)},_hydrate:function(){var a=this.transform,b=this.geometryType;if(a&&b)for(var l=this.features,e=a.translate[0],f=a.translate[1],g=a.scale[0],c=a.scale[1],x=function(a,b,f){if("esriGeometryPoint"===a)return function(a){a.x=b(a.x);a.y=f(a.y)};if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a)return function(a){a=a.rings||a.paths;var g,k,l,e,v,c,p,x;g=0;for(k=a.length;g<k;g++)for(v=a[g],l=0,e=v.length;l<e;l++)c=v[l],0<l?(p+=c[0],x+=c[1]):(p=c[0],x=c[1]),c[0]=
b(p),c[1]=f(x)};if("esriGeometryEnvelope"===a)return function(a){a.xmin=b(a.xmin);a.ymin=f(a.ymin);a.xmax=b(a.xmax);a.ymax=f(a.ymax)};if("esriGeometryMultipoint"===a)return function(a){a=a.points;var g,k,l,e,v;g=0;for(k=a.length;g<k;g++)l=a[g],0<g?(e+=l[0],v+=l[1]):(e=l[0],v=l[1]),l[0]=b(e),l[1]=f(v)}}(b,function(a){return a*g+e},function(a){return f-a*c}),a=0,b=l.length;a<b;a++)l[a].geometry&&x(l[a].geometry);this.transform=null},quantize:function(a){if(!this.geometryType)return this.transform=null,
this;var b=a.translate[0],l=a.translate[1],e=a.scale[0],f=a.scale[1],g=this.features,c=function(a,b,f){var g,k,l,e,v,c,p=[];g=0;for(k=a.length;g<k;g++)if(l=a[g],0<g){if(c=b(l[0]),l=f(l[1]),c!==e||l!==v)p.push([c-e,l-v]),e=c,v=l}else e=b(l[0]),v=f(l[1]),p.push([e,v]);return 0<p.length?p:null},x=function(a,b,f){if("esriGeometryPoint"===a)return function(a){a.x=b(a.x);a.y=f(a.y);return a};if("esriGeometryPolyline"===a||"esriGeometryPolygon"===a)return function(a){var g,k,l,e,v;l=a.rings||a.paths;v=[];
g=0;for(k=l.length;g<k;g++)e=l[g],(e=c(e,b,f))&&v.push(e);return 0<v.length?(a.rings?a.rings=v:a.paths=v,a):null};if("esriGeometryMultipoint"===a)return function(a){var g;g=c(a.points,b,f);return 0<g.length?(a.points=g,a):null};if("esriGeometryEnvelope"===a)return function(a){return a}}(this.geometryType,function(a){return Math.round((a-b)/e)},function(a){return Math.round((l-a)/f)}),u,d;u=0;for(d=g.length;u<d;u++)g[u].geometry&&(x(g[u].geometry)||g[u].setGeometry(null));this.transform=a;return this}});
w("extend-esri")&&m.setObject("tasks.FeatureSet",d,q);return d})},"esri/tasks/StatisticDefinition":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(d,m,t,w){d=d(null,{declaredClass:"esri.tasks.StatisticDefinition",toJson:function(){return{statisticType:this.statisticType,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount}}});
t("extend-esri")&&m.setObject("tasks.StatisticDefinition",d,w);return d})},"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../symbols/jsonUtils ./RangeDomain ./CodedValueDomain ./InheritedDomain ./FeatureTemplate".split(" "),function(d,m,t,w,q,c,A,x,e,u,b){d=d(null,{declaredClass:"esri.layers.FeatureType",constructor:function(a){if(a&&m.isObject(a)){this.id=a.id;this.name=a.name;var k=a.symbol;k&&(this.symbol=A.fromJson(k));
var k=a.domains,l,v=this.domains={};for(l in k)if(k.hasOwnProperty(l)){var f=k[l];switch(f.type){case "range":v[l]=new x(f);break;case "codedValue":v[l]=new e(f);break;case "inherited":v[l]=new u(f)}}if(l=a.templates)for(k=this.templates=[],a=0;a<l.length;a++)k.push(new b(l[a]))}},toJson:function(){var a={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()},b,l=this.domains,e=this.templates,f=c.fixJson;if(l){var g=a.domains={};for(b in l)l.hasOwnProperty(b)&&(g[b]=l[b]&&l[b].toJson());
f(g)}e&&(a.templates=t.map(e,function(a){return a.toJson()}));return f(a)}});w("extend-esri")&&m.setObject("layers.FeatureType",d,q);return d})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../graphic".split(" "),function(d,m,t,w,q,c){d=d(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(d){d&&m.isObject(d)&&(this.name=d.name,this.description=d.description,this.drawingTool=d.drawingTool,this.thumbnail=d.thumbnail,
d=d.prototype,this.prototype=new c(d.geometry,null,d.attributes))},toJson:function(){return q.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,thumbnail:q.fixJson(m.clone(this.thumbnail)),prototype:this.prototype&&this.prototype.toJson()})}});m.mixin(d,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",
TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});t("extend-esri")&&m.setObject("layers.FeatureTemplate",d,w);return d})},
"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(d,m,t,w){d=d(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(d){d&&m.isObject(d)&&(this.objectId=d.objectId,this.globalId=d.globalId,this.success=d.success,d.success||(d=d.error,this.error=Error(),this.error.code=d.code,this.error.message=d.description))}});t("extend-esri")&&m.setObject("layers.FeatureEditResult",d,w);return d})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../SpatialReference ../tasks/query ./RenderMode".split(" "),
function(d,m,t,w,q,c,A){d=d([A],{declaredClass:"esri.layers._SnapshotMode",constructor:function(c){this.featureLayer=c;this.pagination=c.queryPagination;this._featureMap={};this._hasPartialFeatures=!1;this._drawFeatures=m.hitch(this,this._drawFeatures);this._queryErrorHandler=m.hitch(this,this._queryErrorHandler)},startup:function(){this.pagination=this.pagination&&null!=this.featureLayer.maxRecordCount;this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(c){this._init&&
(c?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},drawFeature:function(c){var e=c.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(e,c);this._incRefCount(e)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var c=this.featureLayer;c._collection?(c._fireUpdateStart(),
c._refresh(!0),c._fireUpdateEnd()):this._fetchAll()},hasAllFeatures:function(){return!this._hasPartialFeatures},_getRequestId:function(c){return("_"+c.name+c.layerId+c._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var c=this.featureLayer;c._collection||c.suspended||!c.isQueryable()||(c._fireUpdateStart(),this._clearIIf(),this._hasPartialFeatures=!1,this._sendRequest())},_sendRequest:function(d){var e=this.map,u=this.featureLayer,b=u.getDefinitionExpression(),a=new c;a.outFields=u.getOutFields();
a.where=b||"1\x3d1";a.returnGeometry=!0;a.outSpatialReference=new q(e.spatialReference.toJson());a.timeExtent=u.getTimeDefinition();a.maxAllowableOffset=u._maxOffset;a.quantizationParameters=u._quantizationParameters;u._ts&&(a._ts=(new Date).getTime());a.orderByFields=u.supportsAdvancedQueries?u.getOrderByFields():null;a.multipatchOption=u.multipatchOption;this.pagination&&(this._start=a.start=null==d?0:d,a.num=u.maxRecordCount);var k;u._usePatch&&(k=this._getRequestId(u),this._cancelPendingRequest(null,
k));u._task.execute(a,this._drawFeatures,this._queryErrorHandler,k)},_drawFeatures:function(c){this._purgeRequests();var e=c.features,d=this.featureLayer,b=d.objectIdField,a,k=e.length,l=c.exceededTransferLimit&&!d._collection,v=d._selectedFeatures,f=d.mode===d.constructor.MODE_AUTO,g,p,r;d._fireUpdateStart();d._sortFeatures(e);for(a=0;a<k;a++)p=e[a],r=p.attributes[b],g=this._addFeatureIIf(r,p),this._incRefCount(r),f&&g!==p&&v[r]&&(g.setGeometry(p.geometry),g.setAttributes(p.attributes));this._applyTimeFilter(!0);
this.pagination&&l||(this._hasPartialFeatures=!!c.exceededTransferLimit,d._fireUpdateEnd(null,c.exceededTransferLimit?{queryLimitExceeded:!0}:null));l&&(this.pagination&&this._sendRequest(this._start+d.maxRecordCount),d.onQueryLimitExceeded())},_queryErrorHandler:function(c){this._purgeRequests();this._hasPartialFeatures=!0;var e=this.featureLayer;e._errorHandler(c);e._fireUpdateEnd(c)}});t("extend-esri")&&m.setObject("layers._SnapshotMode",d,w);return d})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script ../kernel".split(" "),
function(d,m,t,w,q,c,A){m=m(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(d._scopeName||"dojo")+"IoScript"},initialize:function(c){this.map=c;this._init=!0},startup:function(){},propertyChangeHandler:function(c){},destroy:function(){this._init=!1},drawFeature:function(c){},suspend:function(){},resume:function(){},refresh:function(){},hasAllFeatures:function(){return!0},_incRefCount:function(c){(c=this._featureMap[c])&&c._count++},_decRefCount:function(c){(c=
this._featureMap[c])&&c._count--},_getFeature:function(c){return this._featureMap[c]},_addFeatureIIf:function(c,e){var d=this._featureMap,b=d[c],a=this.featureLayer;b||(d[c]=e,a._add(e),e._count=0);return b||e},_removeFeatureIIf:function(c){var e=this._featureMap[c],d=this.featureLayer;if(e){if(e._count)return;delete this._featureMap[c];d._remove(e)}return e},_clearIIf:function(){var c;c=this.featureLayer;var e=c.graphics,d=c._selectedFeatures,b=c.getSelectedFeatures().length,a=c.objectIdField;if(b)for(c=
e.length-1;0<=c;c--){var b=e[c],k=b.attributes[a];k in d?b._count=1:(b._count=0,this._removeFeatureIIf(k))}else c.clear(),this._featureMap={}},_isPending:function(d){return c[this._prefix+d]?!0:!1},_cancelPendingRequest:function(d,e){if(d=d||c[this._prefix+e])try{d.cancel(),c._validCheck(d)}catch(u){}},_purgeRequests:function(){c._validCheck(null)},_toggleVisibility:function(c){var e=this.featureLayer,d=e.graphics,b=c?"show":"hide",a,k=d.length;c=c&&e._ager;for(a=0;a<k;a++){var l=d[a];l[b]();c&&e._repaint(l)}},
_applyTimeFilter:function(c){var e=this.featureLayer;if(e.timeInfo&&!e.suspended){c||e._fireUpdateStart();var d=e._trackManager;d&&d.clearTracks();var b=e.getTimeDefinition(),a=e._getOffsettedTE(e._mapTimeExtent);a?(a=e._getTimeOverlap(b,a))?(b=e._filterByTime(e.graphics,a.startTime,a.endTime),d&&d.addFeatures(b.match),w.forEach(b.match,function(a){var b=a._shape;a.visible||(a.show(),(b=a._shape)&&b._moveToFront());e._ager&&b&&e._repaint(a)}),w.forEach(b.noMatch,function(a){a.visible&&a.hide()})):
this._toggleVisibility(!1):(d&&d.addFeatures(e.graphics),this._toggleVisibility(!0));d&&(d.moveLatestToFront(),d.drawTracks());c||e._fireUpdateEnd()}}});q("extend-esri")&&t.setObject("layers._RenderMode",m,A);return m})},"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has ../kernel ../geometry/Point ../tasks/query ./RenderMode ./GridLayout".split(" "),function(d,m,t,w,q,c,A,x,e,u){d=d([e],{declaredClass:"esri.layers._OnDemandMode",
constructor:function(b){this.featureLayer=b;this._featureMap={};this._hasPartialFeatures=!1;this._queryErrorHandler=t.hitch(this,this._queryErrorHandler)},initialize:function(b){this.inherited(arguments);var a=this.featureLayer,k=a._srInfo;this._gridLayer=new u(new A(k?k.valid[0]:b.extent.xmin,k?k.valid[1]:b.extent.ymax,b.spatialReference),{width:a._tileWidth,height:a._tileHeight},{width:b.width,height:b.height},k);this._cellMap={};this._gridLayer.setResolution(b.extent)},startup:function(){this._ioQueue=
[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(b){this._init&&(2>b?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(b){var a=b.geometry,k=[];if(a){var k=this._gridLayer.getCellsInExtent("point"===a.type?{xmin:a.x,
ymin:a.y,xmax:a.x,ymax:a.y}:a.getExtent(),!1).cells,a=this._cellMap,c,e,f=b.attributes[this.featureLayer.objectIdField],g,d,r;for(c=0;c<k.length;c++)e=k[c],g=e.latticeID,d=e.row,r=e.col,g?e=a[g]=a[g]||e:(a[d]=a[d]||{},e=a[d][r]=a[d][r]||e),e.features=e.features||[],e.features.push(b),this._addFeatureIIf(f,b),this._incRefCount(f)}},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},refresh:function(){this._zoomHandler()},
hasAllFeatures:function(){if(this._hasPartialFeatures)return!0;var b=!1,a=this._getCurrentCells(),k;for(k=0;k<a.length;k++)if(a[k].hasPartialFeatures){b=!0;break}return!b},_enableConnectors:function(){var b=this.map;this._zoomConnect=m.connect(b,"onZoomEnd",this,this._zoomHandler);this._panConnect=m.connect(b,"onPanEnd",this,this._panHandler);this._resizeConnect=m.connect(b,"onResize",this,this._panHandler)},_disableConnectors:function(){m.disconnect(this._zoomConnect);m.disconnect(this._panConnect);
m.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var b=this.featureLayer,a=this.map;!b.suspended&&b.isQueryable()&&(b._fireUpdateStart(),this._clearIIf(),this._hasPartialFeatures=!1,(b=b._trackManager)&&b.clearTracks(),this._cellMap={},this._gridLayer.setResolution(a.extent),this._sendRequest())},_panHandler:function(b){if(this.featureLayer.isQueryable()){this.featureLayer._fireUpdateStart();var a=this.featureLayer._resized;b=a?b:null;a&&this._gridLayer.setMapState(b,
this.map.width,this.map.height);this._sendRequest(b)}},_getRequestId:function(b,a){return("_"+b.name+b.layerId+b._ulid+"_"+a.resolution+"_"+(a.latticeID||a.row+"_"+a.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(b){this._exceeds=!1;var a=this.featureLayer,k=this.map;b=b||k.extent;k=this._gridLayer.getCellsInExtent(b,a.latticeTiling).cells;if(!a.isEditable())var c=this._cellMap,k=w.filter(k,function(a){if(a.lattice){if(c[a.latticeID])return!1}else if(c[a.row]&&c[a.row][a.col])return!1;
return!0});var e=a.getOutFields(),f=a.getDefinitionExpression(),g=a._getOffsettedTE(a._mapTimeExtent),d=a.supportsAdvancedQueries?a.getOrderByFields():null,r=a._usePatch,z=this._ioQueue,u,m=this,q=this._drawFeatures,t,B,D;this._pending=this._pending||0;for(u=0;u<k.length;u++){t=k[u];B=new x;B.geometry=t.extent||t.lattice;B.outFields=e;B.where=f;a.latticeTiling&&t.extent&&(B.spatialRelationship=x.SPATIAL_REL_CONTAINS);B.returnGeometry=!0;B.timeExtent=g;a._ts&&(B._ts=(new Date).getTime());B.orderByFields=
d;B.multipatchOption=a.multipatchOption;B.maxAllowableOffset=a._maxOffset;B.quantizationParameters=a._quantizationParameters;(D=a.advancedQueryCapabilities)&&D.supportsQueryWithResultType&&(B.resultType="tile");D=null;if(r&&(D=this._getRequestId(a,t),this._isPending(D)))continue;this._pending++;z.push(a._task.execute(B,function(){var a=t;return function(b){q.apply(m,[b,a])}}.call(this),this._queryErrorHandler,D))}this._removeOldCells(b);this._endCheck()},_drawFeatures:function(b,a){a.hasPartialFeatures=
!!b.exceededTransferLimit;this._exceeds=this._exceeds||b.exceededTransferLimit;this._finalizeIO();var k=this.featureLayer,c=this.map.extent,e=a.extent,f=a.row,g=a.col,d=k.objectIdField,r=b.features,z=this._gridLayer,u=this._cellMap,m=a.latticeID,q=m?u[m]:u[f]&&u[f][g];if(a.resolution==z._resolution&&(m?m===z.getLatticeID(c):z.intersects(e,c)))if(q)k._sortFeatures(r),this._updateCell(q,r);else for(k._sortFeatures(r),a.features=r,m?u[m]=a:(u[f]=u[f]||{},u[f][g]=a),c=r.length,k=0;k<c;k++)e=r[k],f=e.attributes[d],
this._addFeatureIIf(f,e),this._incRefCount(f);else q&&this._removeCell(f,g,m);this._endCheck()},_queryErrorHandler:function(b){this._finalizeIO();this._hasPartialFeatures=!0;this.featureLayer._errorHandler(b);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(b){if(0===this._pending){this._processIOQueue();var a=this.featureLayer,k=a._trackManager;k&&(k.clearTracks(),k.addFeatures(a.graphics),a._ager&&w.forEach(a.graphics,function(b){b._shape&&a._repaint(b)}),
k.moveLatestToFront(),k.drawTracks());this.featureLayer._fireUpdateEnd(b&&Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)a.onQueryLimitExceeded()}},_processIOQueue:function(b){this._ioQueue=w.filter(this._ioQueue,function(a){return-1<a.fired?!1:!0});b&&w.forEach(this._ioQueue,this._cancelPendingRequest)},_getCurrentCells:function(b){var a=[];b=b||this._cellMap;for(var k in b)if(b.hasOwnProperty(k)){var c=b[k];c&&(c.hasOwnProperty("row")||
c.hasOwnProperty("latticeID")?a.push(c):"object"===typeof c&&a.push.apply(a,this._getCurrentCells(c)))}return a},_removeOldCells:function(b){var a=this._cellMap,c=this._gridLayer,e,d;for(e in a)if(a[e]){var f=a[e],g=f.latticeID,p=0,r=0;if(g)p++,g!==c.getLatticeID(b)&&(this._removeCell(null,null,g),r++);else for(d in f)f[d]&&(p++,c.intersects(f[d].extent,b)||(this._removeCell(e,d),r++));r===p&&delete a[e]}},_updateCell:function(b,a){var c=this.featureLayer,e=c.objectIdField,c=c._selectedFeatures,d,
f=a.length;b.features=b.features||[];for(d=0;d<f;d++){var g=a[d],p=g.attributes[e],r=this._addFeatureIIf(p,g);r===g?(this._incRefCount(p),b.features.push(r)):p in c||(r.setGeometry(g.geometry),r.setAttributes(g.attributes))}},_removeCell:function(b,a,c){var k=this._cellMap,e=this.featureLayer,f=e.objectIdField,g=c?k[c]:k[b]&&k[b][a];if(g)for(c?delete k[c]:delete k[b][a],b=g.features,a=0;a<b.length;a++)c=b[a].attributes[f],this._decRefCount(c),c in e._selectedFeatures||this._removeFeatureIIf(c)}});
q("extend-esri")&&t.setObject("layers._OnDemandMode",d,c);return d})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../geometry/Extent ../geometry/Polyline".split(" "),function(d,m,t,w,q,c,A,x){d=d(null,{declaredClass:"esri.layers._GridLayout",constructor:function(c,d,b,a){this.origin=c;this.cellWidth=d.width;this.cellHeight=d.height;this.mapWidth=b.width;this.mapHeight=b.height;this.srInfo=a},setResolution:function(c){this._resolution=
(c.xmax-c.xmin)/this.mapWidth;this.srInfo&&(c=Math.round(Math.round(2*this.srInfo.valid[1]/this._resolution)/this.cellWidth),this._frameStats=[c,0,c-1])},setMapState:function(c,d,b){this.mapWidth=d;this.mapHeight=b;this.setResolution(c)},getCellCoordinates:function(c){var e=this._resolution,b=this.origin;return{row:Math.floor((b.y-c.y)/(this.cellHeight*e)),col:Math.floor((c.x-b.x)/(this.cellWidth*e))}},normalize:function(c){var e=this._frameStats;if(e){var b=e[0],a=e[1],e=e[2];c<a?(c%=b,c=c<a?c+b:
c):c>e&&(c%=b)}return c},intersects:function(c,d){var b=this.srInfo;return b?t.some(d._getParts(b),function(a){return c.intersects(a.extent)}):c.intersects(d)},getCellExtent:function(e,d){var b=this._resolution,a=this.origin,k=this.cellWidth,l=this.cellHeight;return new A(d*k*b+a.x,a.y-(e+1)*l*b,(d+1)*k*b+a.x,a.y-e*l*b,new c(a.spatialReference.toJson()))},getLatticeID:function(c){var e=this.getCellCoordinates({x:c.xmin,y:c.ymax}),b=this.getCellCoordinates({x:c.xmax,y:c.ymin});c=e.row;var a=b.row,
e=this.normalize(e.col),b=this.normalize(b.col);return c+"_"+a+"_"+e+"_"+b},sorter:function(c,d){return c<d?-1:1},getCellsInExtent:function(c,d){var b=this.getCellCoordinates({x:c.xmin,y:c.ymax}),a=this.getCellCoordinates({x:c.xmax,y:c.ymin}),k=b.row,l=a.row,b=b.col,a=a.col,e=[],f,g,p,r=[],z=[],m,q,u,w,B=[];for(f=k;f<=l;f++)for(g=b;g<=a;g++)p=this.normalize(g),c=this.getCellExtent(f,p),t.some(e,function(a){return a.row===f&&a.col===p})||e.push({row:f,col:p,extent:c,resolution:this._resolution}),d&&
(r.push(c.xmin,c.xmax),z.push(c.ymin,c.ymax));b=this.normalize(b);a=this.normalize(a);r.sort(this.sorter);z.sort(this.sorter);g=r.length;for(f=g-1;0<=f;f--)f<g-1&&r[f]===r[f+1]&&r.splice(f,1);g=z.length;for(f=g-1;0<=f;f--)f<g-1&&z[f]===z[f+1]&&z.splice(f,1);if(r.length&&z.length){m=r[0];q=r[r.length-1];u=z[0];w=z[z.length-1];g=r.length;for(f=0;f<g;f++)B.push([[r[f],w],[r[f],u]]);g=z.length;for(f=0;f<g;f++)B.push([[m,z[f]],[q,z[f]]]);r=new x({paths:B,spatialReference:this.origin.spatialReference.toJson()});
e.push({latticeID:k+"_"+l+"_"+b+"_"+a,lattice:r,resolution:this._resolution})}return{minRow:k,maxRow:l,minCol:b,maxCol:a,cells:e}}});w("extend-esri")&&m.setObject("layers._GridLayout",d,q);return d})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","./RenderMode"],function(d,m,t,w,q){d=d([q],{declaredClass:"esri.layers._SelectionMode",constructor:function(c){this.featureLayer=c;this._featureMap={}},propertyChangeHandler:function(c){this._init&&
0===c&&this._applyTimeFilter()},resume:function(){this.propertyChangeHandler(0)},hasAllFeatures:function(){return!this.featureLayer._hasPartialSelectedFeatures}});t("extend-esri")&&m.setObject("layers._SelectionMode",d,w);return d})},"esri/layers/StreamMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../tasks/query ../tasks/QueryTask ../geometry/jsonUtils ./RenderMode".split(" "),function(d,m,t,w,q,c,A,x,e,u){d=d([u],{declaredClass:"esri.layers._StreamMode",
constructor:function(b,a){this.featureLayer=b;this._featureMap={};this._setRefreshRate();this._drawBuffer={adds:[],updates:[]};this._timeoutId=null;this._flushDrawBuffer=m.hitch(this,this._flushDrawBuffer);this._featuresByTime={};this._lastEndTimeCheck=null;this._maxFeatureAge=0;b.purgeOptions&&b.purgeOptions.age&&"number"===typeof b.purgeOptions.age&&(this._maxFeatureAge=1E3*Math.ceil(60*b.purgeOptions.age));this._drawFeatures=m.hitch(this,this._drawFeatures);this._queryErrorHandler=m.hitch(this,
this._queryErrorHandler)},startup:function(){},propertyChangeHandler:function(b){this._init&&(0===b?this._applyTimeFilter():3===b?this._redrawAllTracks():console.debug("StreamLayer: Stream Layer only supports changing map time or maximumTrackPoints. Layer id \x3d "+this.featureLayer.id))},destroy:function(){this.inherited(arguments);clearTimeout(this._timeoutId);this._featuresByTime=this._drawBuffer=this._featureMap=null},drawFeature:function(b){var a=this.featureLayer,c=a.objectIdField;this._timeoutId||
(this._timeoutId=setTimeout(this._flushDrawBuffer,this._refreshRate));a._joinField&&this._getFeature(b.attributes[c])?this._drawBuffer.updates.push({oid:b.attributes[c],updates:b}):this._drawBuffer.adds.push(b)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var b=this.featureLayer;b&&(b._relatedUrl||b._keepLatestUrl?(b._fireUpdateStart(),b._refreshing=!0,b.disconnect(),b.clear(),b._relatedQueried=!1,b._keepLatestQueried=!1,b.connect()):(b._fireUpdateStart(),b.clear(),b._fireUpdateEnd()))},
_drawFeatures:function(b,a){this._purgeRequests();var c=this.featureLayer;c._create(b.features||[]);c._fireUpdateEnd(null,a)},_applyTimeFilter:function(b){this.inherited(arguments);this._redrawAllTracks()},_removeFeatures:function(b){var a=this.featureLayer,c=a.objectIdField;b&&t.forEach(b,function(b){b=b.attributes[c];a._unSelectFeatureIIf(b,this);this._decRefCount(b);this._removeFeatureIIf(b)},this)},_addFeatures:function(b){var a=this.featureLayer,c=a._endTimeField,d=a._startTimeField,e,f,g,p=
[],r=[],z=[];e=a._trackManager;f=a.objectIdField;if(e)for(g in b=e.addFeatures(b),b)b.hasOwnProperty(g)&&(p.push(g),b[g].adds&&(r=r.concat(b[g].adds)),b[g].deletes&&(z=z.concat(b[g].deletes)));else r=b;t.forEach(r,function(a){var b=a.attributes[f],g;g=c&&a.attributes[c];!g&&this._maxFeatureAge&&(g=d&&a.attributes[d]?a.attributes[d]+this._maxFeatureAge:Date.now()+this._maxFeatureAge);g&&(g=1E3*Math.ceil(g/1E3),this._featuresByTime[g]?this._featuresByTime[g].push(b):this._featuresByTime[g]=[b]);this._addFeatureIIf(b,
a);this._incRefCount(b)},this);z.length&&this._removeFeatures(z);e&&e.refreshTracks(p)},_updateFeatures:function(b){var a=this.featureLayer,c,e,d=[];c=a._trackManager;e=a._trackIdField;t.forEach(b,function(b){var g=b.updates;b=this._getFeature(b.oid);var f;if(b){g.geometry&&b.setGeometry(g.geometry);g=g.attributes||{};for(f in g)g.hasOwnProperty(f)&&(b.attributes[f]=g[f]);b.setAttributes(b.attributes);b.visible=this._checkFeatureTimeIntersects(b);c&&b.attributes[e]?d.push(b.attributes[e]):a._repaint(b,
null,!0)}},this);d.length&&c.refreshTracks(d)},_redrawAllTracks:function(){var b=this.featureLayer._trackManager,a;b&&(a=b.trimTracks())&&0<a.length&&(this._removeFeatures(a),b.refreshTracks())},_flushDrawBuffer:function(){clearTimeout(this._timeoutId);var b=this._drawBuffer,a=b.adds.splice(0,b.adds.length),c=b.updates.splice(0,b.updates.length),b=this.featureLayer;if(!b)return!1;b.updating||b._fireUpdateStart();this._addFeatures(a);this._updateFeatures(c);(a=this._getExpiredFeatures())&&a.length&&
(this._removeFeatures(a),b._trackManager&&b._trackManager.removeFeatures(a));b._purge();b._fireUpdateEnd();this._timeoutId=null},_clearDrawBuffer:function(){var b=this._timeoutId,a=this._drawBuffer,c=a.adds,a=a.updates;b&&clearTimeout(b);c.splice(0,c.length);a.splice(0,a.length);this._timeoutId=null},_clearTimeBin:function(){this._featuresByTime={};this._lastEndTimeCheck=1E3*Math.ceil(Date.now()/1E3)},_clearFeatureMap:function(){this._featureMap={}},_setRefreshRate:function(b){b=b||0===b?b:200;0>
b&&(b=200);this._refreshRate=b},_checkFeatureTimeIntersects:function(b){var a=this.featureLayer,c=a.getMap();return(c=c?c.timeExtent:null)&&a.timeInfo&&(a.timeInfo.startTimeField||a.timeInfo.endTimeField)?0<a._filterByTime([b],c.startTime,c.endTime).match.length:!0},_getRequestId:function(b){return("_"+b.name+b.layerId+b._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchArchive:function(b){function a(a){z++;v.execute(f).then(function(b){a(null,b)},function(b){a(b)})}function k(b,c){if(b)z>=m||!d._relatedUrl?
q._queryErrorHandler(Error("Could not get features from related feature service")):(u={relatedFeatureWarning:"Querying related feature service using the current filter failed. All related features are displayed, and the filter is applied to the stream service only"},f.where="1\x3d1",a(k));else{var g=q._fixFieldNameCasing(d,c);c.features=g;q._drawFeatures(c,u)}}var d=this.featureLayer,v,f,g,p,r;d._fireUpdateStart();if(b&&this.map){v=new x(b);f=new A;b=this.map;g=d.getFilter()||{};p=g.where||"1\x3d1";
r=g.geometry?e.fromJson(g.geometry):null;g=g.outFields?g.outFields.split(","):["*"];f.geometry=r;f.where=p;f.outFields=g;f.returnGeometry=!0;f.outSpatialReference=new c(b.spatialReference.toJson());d._usePatch&&(b=this._getRequestId(d),this._cancelPendingRequest(null,b));var z=0,m=2,q=this,u=null;a(k)}else return this._fireUpdateEnd({error:"Archive data cannot be fetched if no feature service url is provided or if the layer is not added to a map"}),!1},_queryErrorHandler:function(b){this._purgeRequests();
var a=this.featureLayer;a._errorHandler(b);a._fireUpdateEnd(b)},_fixFieldNameCasing:function(b,a){var c=a.features||[],d=a.fields;if(!d||!c.length)return c;for(var d=this._mapFieldNameDifferences(b.fields,d),e=[],f,g,p=0,r=a.features.length;p<r;p++)f=c[p],g=this._swizzleResponseAttributes(f.attributes,d),e.push({geometry:f.geometry,attributes:g});return e},_mapFieldNameDifferences:function(b,a){var c=[],d={},e,f;e=0;for(f=a.length;e<f;e++)c.push(a[e].name);e=0;for(f=b.length;e<f;e++){var g=b[e].name,
p=this._checkForStreamFieldName(g,c);p&&(d[p]=g)}return d},_checkForStreamFieldName:function(b,a){for(var c=b.toLowerCase(),d,e=0,f=a.length;e<f;e++)if(a[e].toLowerCase()===c){d=a[e];break}return d},_swizzleResponseAttributes:function(b,a){var c={},e;for(e in b)if(b.hasOwnProperty(e)){var d=b[e];a.hasOwnProperty(e)?c[a[e]]=d:c[e]=d}return c},_getExpiredFeatures:function(){var b,a,c,e=[],d=[];if(!this.featureLayer._endTimeField&&!this._maxFeatureAge)return d;b=1E3*Math.floor(this._lastEndTimeCheck/
1E3);this._lastEndTimeCheck=a=1E3*Math.ceil(Date.now()/1E3);if(b&&b!==a)for(c=this._featuresByTime;b<=a;b+=1E3)c[b]&&(e=e.concat(c[b]),delete c[b]);t.forEach(e,function(a){(a=this._getFeature(a))&&d.push(a)},this);return d}});w("extend-esri")&&m.setObject("layers._StreamMode",d,q);return d})},"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/dom-construct dojox/gfx ../kernel ../graphic ../geometry/Polyline ./GraphicsLayer".split(" "),function(d,
m,t,w,q,c,A,x,e,u){var b=-1!==c.renderer.toLowerCase().indexOf("canvas");d=d(null,{declaredClass:"esri.layers._TrackManager",constructor:function(a){this.layer=a;this.trackMap={};this.trackLineMap={}},initialize:function(a){this.map=a;var c=this.layer,e=c._getRenderer(),e=e&&e.trackRenderer;if("esriGeometryPoint"===c.geometryType){var d=this.container=new u._GraphicsLayer({id:c.id+"_tracks",_child:!0,visible:c.visible,minScale:c.minScale,maxScale:c.maxScale});d.loaded=!0;d.onLoad(d);d._setMap(a,c._div);
if(!b){a=d._div.getNode();var f=c._div.getNode();a&&f&&q.place(a,f,"first")}d.setRenderer(e);c.on("visibility-change",m.hitch(this,function(a){this.container.setVisibility(a.visible);this.container.evaluateSuspension()}));c.on("scale-range-change",m.hitch(this,function(){this.container.setScaleRange(this.layer.minScale,this.layer.maxScale)}))}},addFeatures:function(a){var b=this.trackMap,c=this.layer,e=c._trackIdField,f=[];t.forEach(a,function(a){var c=a.attributes[e];(b[c]=b[c]||[]).push(a);-1===
t.indexOf(f,c)&&f.push(c)});var g=c._startTimeField,d=c.objectIdField,r=function(a,b){var c=a.attributes[g],f=b.attributes[g];return c===f?a.attributes[d]<b.attributes[d]?-1:1:c<f?-1:1};t.forEach(f,function(a){b[a].sort(r)})},trimTracks:function(a){function b(a){for(a=c[a]||[];a.length>e;)f.push(a.shift())}var c=this.trackMap,e=this.layer.maximumTrackPoints||0,f=[],g;if(!e)return f;if(a)t.forEach(a,function(a){b(a)});else for(g in c)c.hasOwnProperty(g)&&b(g);return f},drawTracks:function(a){function b(a){var b=
f[a],k,l,r;l=c.trackLineMap[a];d.remove(l);delete c.trackLineMap[a];l=null;if(!b||2>b.length)return!1;l=[];for(k=b.length-1;0<=k;k--)(r=b[k].geometry)&&l.push([r.x,r.y]);b={};b[p]=a;1<l.length&&(l=new x(new e({paths:[l],spatialReference:g}),null,b),d.add(l),c.trackLineMap[a]=l)}var c=this,d=this.container,f,g,p,r;if(d)if(f=this.trackMap,g=this.map.spatialReference,p=this.layer._trackIdField,a)t.forEach(a,function(a){b(a)});else for(r in f)f.hasOwnProperty(r)&&b(r)},refreshTracks:function(a){function b(a){var b,
d;c.drawTracks([a]);if(g&&g.latestObservationRenderer)for(a=e[a]||[],b=a.length,d=0;d<b;d++)f._repaint(a[d],null,!0)}var c=this,e=this.trackMap,f=this.layer,g=f._getRenderer(),d;if(a)t.forEach(a,function(a){b(a)});else for(d in e)e.hasOwnProperty(d)&&b(d);this.moveLatestToFront()},moveLatestToFront:function(a){t.forEach(this.getLatestObservations(a),function(a){var b=a._shape;b&&b._moveToFront();this._repaint(a,null,!0)},this.layer)},getLatestObservations:function(a){function b(a){a=f[a];return a[a.length-
1]}var c=[],d=this.layer._getRenderer(),f=this.trackMap,g;if(!d.latestObservationRenderer)return c;if(a)t.forEach(a,function(a){c.push(b(a))});else for(g in f)f.hasOwnProperty(g)&&c.push(b(g));return c},clearTracks:function(a){var b=this.getLatestObservations(a),c=this.container,d;a?t.forEach(a,function(a){delete this.trackMap[a];c&&(d=this.trackLineMap[a],c.remove(d),delete this.trackLineMap[a])},this):(this.trackMap={},this.trackLineMap={},c&&c.clear());t.forEach(b,function(a){this._repaint(a,null,
!0)},this.layer)},isLatestObservation:function(a){var b=this.trackMap[a.attributes[this.layer._trackIdField]];return b?b[b.length-1]===a:!1},destroy:function(){var a=this.container;a&&(a.clear(),a._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});w("extend-esri")&&m.setObject("layers._TrackManager",d,A);return d})},"esri/layers/HeatmapManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/aspect dojo/_base/array require ../kernel ../sniff ../geometry/Point ../geometry/webMercatorUtils ./MapImage ../renderers/HeatmapRenderer ../tasks/query dojo/_base/fx".split(" "),
function(d,m,t,w,q,c,A,x,e,u,b,a,k){function l(){}function v(a){var b=a.layer;return{geometry:a.geometry,attributes:a.attributes,getLayer:function(){return b}}}d=d(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(a){this.sourceLayer=a;this._hndls=[]},initialize:function(a){this.map=a;var c=this.sourceLayer,d=c.renderer;c.setDrawMode(!1);this.imageLayer=a._getMapImageLyr();var f=this;this.heatmapRenderer=
d instanceof b?d:(d.getRendererInfoByZoom(a.getZoom())||d.getRendererInfoByScale(a.getScale())).renderer;this._setupDraw=this._setupDraw.bind(this);this.recalculateHeatmap=this.recalculateHeatmap.bind(this);this._removeRenderer=this._removeRenderer.bind(this);this._handleRendererChange=this._handleRendererChange.bind(this);this._rendererChangeHandle=this.sourceLayer.on("renderer-change",this._handleRendererChange);this._handleOpacityChange=this._handleOpacityChange.bind(this);this._reprojectFeature=
this._reprojectFeature.bind(this);q(["../workers/heatmapCalculator"],function(a){f._calculator=new a(m.mixin({width:f.map.width,height:f.map.height},f._getOptions()));f._setupRenderer();f.heatmapRenderer.getStats=a.calculateStats;f.heatmapRenderer.getHistogramData=a.getHistogramData})},destroy:function(){this._removeHandlers();this._rendererChangeHandle&&this._rendererChangeHandle.remove();this._rendererChangeHandle=this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=null},
_handleRendererChange:function(a){var c=a.renderer,d=c instanceof b;this.heatmapRenderer?d?this.heatmapRenderer=c:this._removeRenderer(a):d&&(this.heatmapRenderer=c,this.sourceLayer&&this.map&&this._setupRenderer())},_handleOpacityChange:function(a){a=a.opacity;var b=this._getImageBySourceId(this.sourceLayer.id);b&&b.setOpacity(a)},_setupRenderer:function(){var a=this._hndls,b=this.sourceLayer,c=this.map,d=this;b._originalDraw=b._draw;b._draw=l;b._div.clear();clearTimeout(this._resetTimer);this._resetTimer=
setTimeout(this._resetGraphics.bind(this),250);a.push(b.on("update-end",this._setupDraw));a.push(b.on("suspend",function(a){(a=d._getImageBySourceId(d.sourceLayer.id))&&a.hide()}));a.push(b.on("resume",function(a){(a=d._getImageBySourceId(d.sourceLayer.id))&&a.show()}));a.push(t.after(b,"redraw",this._setupDraw));a.push(c.on("layer-remove",function(a){a.layer==b&&((a=d._getImageBySourceId(d.sourceLayer.id))&&d.imageLayer.removeImage(a),d._removeRenderer({target:b}))}));b._collection&&a.push(b.on("graphic-add",
function(a){d._reprojectFeature(a.graphic);d._setupDraw()}));1!==b.mode&&(a.push(c.on("resize, pan-end",this._setupDraw)),a.push(c.on("zoom-end",this._setupDraw)));a.push(b.on("opacity-change",this._handleOpacityChange));this.imageLayer.suspended&&this.imageLayer.resume();b.graphics&&b.graphics.length&&(b.graphics[0].geometry&&!c.spatialReference.equals(b.graphics[0].geometry.spatialReference)&&w.forEach(b.graphics,function(a){this._reprojectFeature(a)}.bind(this)),this._setupDraw())},_setupDraw:function(){if(!this._drawTimer){var a=
this;this._drawTimer=setTimeout(function(){clearTimeout(a._drawTimer);a._drawTimer=null;a.sourceLayer._getRenderer().isInstanceOf(b)&&a.recalculateHeatmap()},16)}},_removeRenderer:function(a){var b=a.target;b._draw=b._originalDraw;delete b._originalDraw;b.setDrawMode(!0);this._removeHandlers();this._hndls=[];var c=this._getImageBySourceId(this.sourceLayer.id);c&&this.imageLayer.removeImage(c);clearTimeout(this._drawTimer);clearTimeout(this._resetTimer);this._drawTimer=this._resetTimer=null;b.renderer!=
a.renderer&&b.renderer.getRendererInfo?this.heatmapRenderer=null:(b.redraw(),this.destroy())},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&this._doWorkerCalculation()},_reprojectFeature:function(a){if(a&&a.geometry){var b=a.geometry,c=this.map.spatialReference;c.equals(b.spatialReference)||(b=e.project(b,c),null==b?console.log("Unable to reproject features to map's spatial reference. Please convert feature geometry before adding to layer"):a.geometry=
b)}},_doWorkerCalculation:function(){},_doMainCalculation:function(){var b=this.sourceLayer,c=this.map,d=this.heatmapRenderer,e=this.map.extent,k=this.map.width,l=this.map.height,q=this._calculator,t=this,w=function(a){a=t._getScreenPoints(a.features,c,b);a=q.calculateImageData(m.mixin({screenPoints:a,mapinfo:{extent:[e.xmin,e.ymin,e.xmax,e.ymax],resolution:c.getResolution()},width:k,height:l},t._getOptions()));a=d.getSymbol(v({geometry:c.extent,attributes:{size:[k,l],imageData:a},layer:b}));a=new u({extent:c.extent,
href:a.url,opacity:0,sourceId:b.id});t._swapMapImages(a,t._getImageBySourceId(b.id));b.suspended&&a.hide()},x={geometry:c.extent,timeExtent:b.useMapTime?c.timeExtent:void 0,spatialRelationship:a.SPATIAL_REL_INTERSECTS};null!=b._canDoClientSideQuery(x)?b.queryFeatures(x,w):w({features:b.graphics})},_getScreenPoints:function(a,b,c){var d=[],e=a.length,g=0,f=0,k,l=new x(b.extent.xmin,b.extent.ymax,b.spatialReference),m=b.toScreen(l),q=m.x,m=m.y,p=b.getResolution(),u;for((f=b.extent.getCacheValue("_parts"))&&
(u=w.map(f,function(a){return c._intersects(b,a.extent)[0]}));e--;)f=a[e],f.geometry&&(k={x:Math.ceil((f.geometry.x-l.x)/p+q),y:Math.floor((l.y-f.geometry.y)/p-m),attributes:f.attributes},u&&(f=1<u.length&&k.x<-u[0]?u[1]:u[0],k.x+=f),d[g++]=k);return d},_getImageBySourceId:function(a){var b=this.imageLayer.getImages(),b=w.filter(b,function(b){return b.sourceId==a});if(b.length)return b[b.length-1]},_swapMapImages:function(a,b){function c(){d.removeImage(b)}var d=this.imageLayer,e=this.sourceLayer.opacity;
d.addImage(a);k.anim(a._node,{opacity:e},null,null,function(){a.opacity=e});null!=b&&k.anim(b._node,{opacity:0},null,null,c)},_removeHandlers:function(){if(null!=this._hndls)for(var a=this._hndls.length;a--;)this._hndls[a].remove()},_getOptions:function(){var a=this.heatmapRenderer;return{blurRadius:a.blurRadius,gradient:a.gradient,maxPixelIntensity:a.maxPixelIntensity,minPixelIntensity:a.minPixelIntensity,field:a.field,fieldOffset:a.fieldOffset}},_resetGraphics:function(){clearTimeout(this._resetTimer);
this._resetTimer=null;for(var a=this.sourceLayer.graphics,b=a.length,c;b--;)c=a[b],c._shape=c._offsets=void 0}});A("extend-esri")&&m.setObject("layers.HeatmapManager",d,c);return d})},"*noref":1}});
define("esri/layers/FeatureLayer","require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/promise/all ../kernel ../lang ../request ../config ../deferredUtils ../SpatialReference ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../renderers/arcadeUtils ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./FeatureType ./FeatureTemplate ./FeatureEditResult ./LabelClass ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./TrackManager ./HeatmapManager dojo/i18n!../nls/jsapi dojo/has!extend-esri?./agscommon".split(" "),function(d,
m,t,w,q,c,A,x,e,u,b,a,k,l,v,f,g,p,r,z,J,F,R,M,B,D,S,T,U,V,K,I,W,N,X,Y,Z,aa,ba,ca,da,ea,G,fa,L,ga,ha,ia,O,P,ja){var ka=r.defaults,C=t(aa,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/(https?:)?\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],
"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,b){this._preventInit||this._initFeatureLayer(a,b)},_initFeatureLayer:function(a,b){this.i18n=ja;b=b||{};this.showLabels=null!=b.showLabels?b.showLabels:!0;
this._outFields=b.outFields;this._defnExpr=b.definitionExpression;this._loadCallback=b.loadCallback;var h=b._usePatch;this._usePatch=null===h||void 0===h?!0:h;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;this._maxOffset=null!=b.maxAllowableOffset?b.maxAllowableOffset:this.maxAllowableOffset;this.quantize=null!=b.quantize?b.quantize:!0;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;this.userIsAdmin=
b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=b.gdbVersion;this.orderByFields=b.orderByFields;this.maxPointCountForAuto=null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;this.generalizeForScale=
null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;this.queryPagination=null!=b.queryPagination?b.queryPagination:this.url?this.reHostedFS.test(this.url):!1;this.multipatchOption=b.multipatchOption;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var c=C,h=this.mode=g.isDefined(b.mode)?b.mode:c.MODE_ONDEMAND;this._isStream&&(this.mode=h=c.MODE_STREAM);switch(h){case c.MODE_SNAPSHOT:this.currentMode=
c.MODE_SNAPSHOT;this._mode=new L(this);this._isSnapshot=!0;break;case c.MODE_ONDEMAND:case c.MODE_AUTO:this.currentMode=c.MODE_ONDEMAND;this._tileWidth=b.tileWidth||512;this._tileHeight=b.tileHeight||512;this._mode=new ga(this);this.latticeTiling=b.latticeTiling;break;case c.MODE_SELECTION:this.currentMode=c.MODE_SELECTION;this._mode=new ha(this);this._isSelOnly=!0;break;case c.MODE_STREAM:this.currentMode=c.MODE_STREAM,this._mode=new ia(this),this._isStream=!0}this._initLayer=q.hitch(this,this._initLayer);
this._selectHandler=q.hitch(this,this._selectHandler);this._editable=!1;if(q.isObject(a)&&a.layerDefinition)return this._collection=!0,this.mode=this._isStream?c.MODE_STREAM:c.MODE_SNAPSHOT,this._isStream||this._outFields||(this._outFields=["*"]),this._initLayer(a),this;this._task=new V(this.url,{source:this.source,gdbVersion:this.gdbVersion});h=this._url.path;this._fserver=!1;-1!==h.search(/\/FeatureServer\//i)&&(this._fserver=!0);this.mode===c.MODE_AUTO&&this.reHostedFS.test(this.url)&&this._queryLimit();
(c=b.resourceInfo)?this._initLayer(c):(this.source&&(c={source:this.source.toJson()},this._url.query=q.mixin(this._url.query,{layer:A.toJson(c)})),this.gdbVersion&&(this._url.query=q.mixin(this._url.query,{gdbVersion:this.gdbVersion})),p({url:h,content:q.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},_initLayer:function(a,b){if(a||b){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||
a&&a._ssl)this._useSSL(),this._task._useSSL();this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);this._collection&&(this._isStream||(this.currentMode=C.MODE_SNAPSHOT,this._mode=new L(this)),this._isSnapshot=!0,this._featureSet=a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);this.geometryType=a.geometryType;"string"!==typeof this.multipatchOption&&
"esriGeometryMultiPatch"===this.geometryType&&(this.multipatchOption="xyFootprint");if(a.hasOwnProperty("capabilities")){var h=this.capabilities=a.capabilities;h&&-1!==h.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=!1}else this._collection||(this._editable=this._fserver);g.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1);this._json=A.toJson(this._json);this.isEditable()?this._setMaxOffset(null):
this.mode===C.MODE_SNAPSHOT||"esriGeometryPolyline"!==this.geometryType&&"esriGeometryPolygon"!==this.geometryType&&!this.hasXYFootprint()||(this._autoGeneralize=g.isDefined(this._optAutoGen)?this._optAutoGen:this.mode===C.MODE_ONDEMAND||this.mode===C.MODE_AUTO,delete this._optAutoGen);var h=a.effectiveMinScale||a.minScale,n=a.effectiveMaxScale||a.maxScale;!this._hasMin&&h&&this.setMinScale(h);!this._hasMax&&n&&this.setMaxScale(n);this.layerId=a.id;this.name=a.name;this.description=a.description;
this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression||(a.isView?a.viewDefinitionQuery:a.definitionQuery);this.fullExtent=new N(a.extent);this.initialExtent=new N(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new J(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;if("esriGeometryPoint"===this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=
!1;this.hasM=a.hasM||!1;this.hasZ=a.hasZ||!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.supportsCalculate=a.supportsCalculate;this.supportsAttachmentsByUploadId=a.supportsAttachmentsByUploadId;this.supportsCoordinatesQuantization=a.supportsCoordinatesQuantization;this.quantize=this.quantize&&this.supportsCoordinatesQuantization;
this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailureParameter=this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=
a.relationships;this.allowGeometryUpdates=g.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this.allowUpdateWithoutMValues=!!a.allowUpdateWithoutMValues;this.advancedQueryCapabilities=a.advancedQueryCapabilities||{supportsStatistics:this.supportsStatistics,supportsOrderBy:this.supportsAdvancedQueries,supportsDistinct:this.supportsAdvancedQueries};this.useStandardizedQueries=a.useStandardizedQueries;this.tileMaxRecordCount=a.tileMaxRecordCount;this.standardMaxRecordCount=a.standardMaxRecordCount;
this._setMaxOffset(this._maxOffset,!0);this._isTable="Table"===this.type;for(var d=this.fields=[],n=a.fields,h=0;h<n.length;h++)d.push(new ba(n[h]));if(!this.objectIdField){this.objectIdField=a.objectIdField;if(!this.objectIdField)for(n=a.fields,h=0;h<n.length;h++)if(d=n[h],"esriFieldTypeOID"===d.type){this.objectIdField=d.name;break}this.objectIdField||this._isStream||console.debug("esri.layers.FeatureLayer: "+g.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!g.isDefined(this._nextId)){n=
this.objectIdField;d=-1;if(this._collection&&n)for(var e=(h=this._featureSet)&&h.features,f=e?e.length:0,k,h=0;h<f;h++)k=(k=e[h].attributes)&&k[n],k>d&&(d=k);this._nextId=d+1}this.globalIdField=a.globalIdField;if(h=this.typeIdField=a.typeIdField)if(h=!this._getField(h)&&this._getField(h,!0))this.typeIdField=h.name;this.visibilityField=a.visibilityField;if(n=a.defaultSymbol)this.defaultSymbol=B.fromJson(n);var l=this.types=[],m=a.types,H,r,d=(h=this.editFieldsInfo)&&h.creatorField,e=h&&h.editorField;
k=d||e;f=[];if(m)for(h=0;h<m.length;h++)H=new da(m[h]),r=H.templates,k&&r&&r.length&&(f=f.concat(r)),l.push(H);m=a.templates;H=this.templates=[];if(m)for(h=0;h<m.length;h++)l=new ea(m[h]),k&&f.push(l),H.push(l);for(h=0;h<f.length;h++)if(k=q.getObject("prototype.attributes",!1,f[h]))d&&delete k[d],e&&delete k[e];if(h=a.timeInfo)this.timeInfo=new ca(h),this._startTimeField=h.startTimeField,this._endTimeField=h.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?
h.trackIdField=this._trackIdField:this._trackIdField=h.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var h=a.drawingInfo,p;(d=h&&h.labelingInfo)&&!this.labelingInfo&&(this.labelingInfo=c.map(d,function(a){return new fa(a)}),this._fixLabelExpr());if(!this.renderer)if(h&&h.renderer){if(p=h.renderer,this.setRenderer(T.fromJson(p)),"classBreaks"===p.type&&this.renderer.setMaxInclusive(!0),!this._collection){var t=p.type,n=[];p=this.renderer;
switch(t){case "simple":n.push(p.symbol);break;case "uniqueValue":case "classBreaks":n.push(p.defaultSymbol),n=n.concat(c.map(p.infos,function(a){return a.symbol}))}var n=c.filter(n,g.isDefined),v=this._url.path+"/images/",w=this._getToken();c.forEach(n,function(a){var h=a.url;h&&(-1===h.search(/https?\:/)&&-1===h.indexOf("data:")&&(a.url=v+h),w&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+w))})}}else if(n)m=this.types,0<m.length?(p=new S(this.defaultSymbol,this.typeIdField),c.forEach(m,function(a){p.addValue(a.id,
a.symbol)})):p=new D(this.defaultSymbol),this.setRenderer(p);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":t=new F;break;case "esriGeometryPolyline":t=new R;break;case "esriGeometryPolygon":t=new M;break;default:this.hasXYFootprint()&&(t=new M)}this.setRenderer(t?new D(t):null)}t=h&&h.transparency||0;!this.hasOwnProperty("opacity")&&0<t&&(this.opacity=1-t/100);(u("ie")||7<=u("trident")||u("safari"))&&this.isEditable()&&10.02>this.version&&
(this._ts=!0);this.statistics=a.statistics;this._fixRendererFields();this._updateRequiredFieldsFromLabelingInfo();this._checkFields();this._updateCaps();var x=function(){this.currentMode!==C.MODE_SNAPSHOT&&(this.queryPagination=!1);null==this._maxOffset||this._isFractionalOffsetAllowed()||this._setMaxOffset(this._maxOffset);this.loaded=!0;this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?(t=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new I(t)),
this._fcAdded=!0,x.call(this)):this._forceIdentity(this._limitPromise?function(){var a=this;this._limitPromise.then(function(h){a._checkMode(h)});this._limitPromise.always(function(){a._limitPromise=null;x.call(a)})}:x)}},setShowLabels:function(a){this.showLabels=a;this.onShowLabelsChange()},onShowLabelsChange:function(){},onRendererChange:function(a){this.inherited(arguments);var h=this._map;this._ager=!!(a&&a.observationAger&&a.observationRenderer);a&&"colors"in a&&"blurRadius"in a&&"maxPixelIntensity"in
a?"esriGeometryPoint"==this.geometryType&&!this._heatmapManager&&h&&(this._heatmapManager=new P(this),this._heatmapManager.initialize(h)):this.renderer&&this.renderer.getRendererInfo?c.some(this.renderer.rendererInfos,function(a){return a.renderer&&"colors"in a.renderer&&"blurRadius"in a.renderer})||(this._heatmapManager=null):this._heatmapManager=null;this.timeInfo&&h&&(a&&(a.latestObservationRenderer||a.trackRenderer)?this._trackManager||(this._trackManager=new O(this),this._trackManager.initialize(h),
this._childLayer=this._trackManager.container,this._mode._applyTimeFilter()):this._trackManager&&!this._isStream&&(this._trackManager.destroy(),this._trackManager=null));if(a){var b=[],h=c.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],g.isDefined),d=function(a){return null!=a&&"function"!=typeof a&&a};c.forEach(h,function(a){var h=d(a.attributeField),c=d(a.attributeField2);a=d(a.attributeField3);!1!==h&&b.push(h);!1!==c&&b.push(c);!1!==a&&b.push(a)});this._requiredFields=
b}else this._requiredFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._requiredFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!!(a&&a.observationAger&&a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&
a.trackRenderer)},_setMap:function(a){var h=this.inherited(arguments),b=this._mode,c=this;b&&b.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=c._selectedFeatures[a&&a[c.objectIdField]])&&a.attr("data-selected","")});return h},_unsetMap:function(a){var b=this._mode;b&&b.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=
null);w.disconnect(this._zoomConnect);w.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){this._needsRefresh=!1;var a=this._mode;a&&a.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return c.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},getField:function(a){return this._getField(a,
!0)},getFieldLabel:function(a){var b=this.infoTemplate,b=b&&b.getFieldInfo&&b.getFieldInfo(a);a=q.isFunction(a)?null:this.getField(a);var h=b||a,c="";h&&(c=b&&b.label||a&&a.alias||h.name||h.fieldName);return c},getDomain:function(a,b){var h,n,d=b&&b.feature,e=d&&this.typeIdField&&d.attributes&&d.attributes[this.typeIdField];null!=e&&c.some(this.types,function(b){return b.id==e?((h=b.domains&&b.domains[a])&&"inherited"===h.type&&(h=this._getLayerDomain(a),n=!0),!0):!1},this);n||h||(h=this._getLayerDomain(a));
return h},_getLayerDomain:function(a){var b;c.some(this.fields,function(h){h.name===a&&(b=h.domain);return!!b});return b},getType:function(a){var b,h=a&&this.typeIdField&&a.attributes&&a.attributes[this.typeIdField];c.some(this.types,function(a){a.id==h&&(b=a);return!!b});return b},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=a,this;
var b=this._editable;this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return b;var h=a&&a.feature;a=a&&a.userId||this.getUserId();var d=c.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],q.trim),e=(b=-1<c.indexOf(d,"editing"))&&-1<c.indexOf(d,"create"),g=b&&-1<c.indexOf(d,"update"),d=b&&-1<c.indexOf(d,"delete"),f=this.ownershipBasedAccessControlForFeatures,
k=this.editFieldsInfo,l=k&&k.creatorField,k=k&&k.realm,h=(h=h&&h.attributes)&&l?h[l]:void 0,m=!!this.userIsAdmin,l=!f||m||!(!f.allowOthersToUpdate&&!f.allowUpdateToOthers),p=!f||m||!(!f.allowOthersToDelete&&!f.allowDeleteToOthers),r=!f||m||!f.hasOwnProperty("allowAnonymousToUpdate")||f.allowAnonymousToUpdate,f=!f||m||!f.hasOwnProperty("allowAnonymousToDelete")||f.allowAnonymousToDelete;a&&k&&(a=a+"@"+k);if(m||b&&!(e||g||d))e=g=d=!0;b={canCreate:e,canUpdate:g,canDelete:d};a||(b.canUpdate=b.canUpdate&&
r,b.canDelete=b.canDelete&&f);null===h?(b.canUpdate=b.canUpdate&&l,b.canDelete=b.canDelete&&p):""!==h&&h&&a.toLowerCase()!==h.toLowerCase()&&(b.canUpdate=b.canUpdate&&l,b.canDelete=b.canDelete&&p);return b},getUserId:function(){var a;this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,b,c){c=g.isDefined(c)?c:(new Date).getTime();var h=
"";c=this.getEditInfo(a,b,c);(b=b&&b.callback||this.editSummaryCallback)&&(c=b(a,c)||"");if(q.isString(c))h=c;else{if(c){a=c.action;b=c.userId;var n=c.timeValue,d=0;a&&d++;b&&d++;g.isDefined(n)&&d++;1<d&&(h=("edit"===a?"edit":"create")+(b?"User":"")+(g.isDefined(n)?c.displayPattern:""))}h=h&&g.substitute(c,this.i18n.layers.FeatureLayer[h])}return h},getEditInfo:function(a,b,c){if(this.loaded){c=g.isDefined(c)?c:(new Date).getTime();b=b&&b.action||"last";var h=this.editFieldsInfo,n=h&&h.creatorField,
d=h&&h.creationDateField,e=h&&h.editorField,h=h&&h.editDateField,e=(a=a&&a.attributes)&&e?a[e]:void 0,h=a&&h?a[h]:null,n=this._getEditData(a&&n?a[n]:void 0,a&&d?a[d]:null,c);c=this._getEditData(e,h,c);var y;switch(b){case "creation":y=n;break;case "edit":y=c;break;case "last":y=c||n}y&&(y.action=y===c?"edit":"creation");return y}},_getEditData:function(a,b,c){var h,n,d;g.isDefined(b)&&(n=c-b,d=0>n?"Full":6E4>n?"Seconds":12E4>n?"Minute":36E5>n?"Minutes":72E5>n?"Hour":864E5>n?"Hours":6048E5>n?"WeekDay":
"Full");if(void 0!==a||d)h=h||{},h.userId=a,d&&(a=e.format,c=new Date(b),h.minutes=Math.floor(n/6E4),h.hours=Math.floor(n/36E5),h.weekDay=a(c,{datePattern:"EEEE",selector:"date"}),h.formattedDate=a(c,{selector:"date"}),h.formattedTime=a(c,{selector:"time"}),h.displayPattern=d,h.timeValue=b);return h},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},isQueryable:function(){var a=c.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],q.trim);return this._isStream||this.userIsAdmin||
this._collection||-1!==c.indexOf(a,"query")||-1!==c.indexOf(a,"catalog")},setMaxAllowableOffset:function(a){this.isEditable()||this._setMaxOffset(a,!0);return this},getMaxAllowableOffset:function(){var a=this._quantizationParameters?this._quantizationParameters.tolerance:void 0;return null!=this._maxOffset?this._maxOffset:a},_setMaxOffset:function(a,b){if(null==a)return delete this._maxOffset,delete this._quantizationParameters,this;this.quantize&&this.supportsCoordinatesQuantization?("esriGeometryPolyline"===
this.geometryType?this._maxOffset=a:delete this._maxOffset,this._quantizationParameters={mode:"view",originPosition:"upperLeft",tolerance:a,extent:this.fullExtent}):(this._isFractionalOffsetAllowed()&&b||(a=Math.floor(a)),isNaN(a)||0===a?delete this._maxOffset:this._maxOffset=a,delete this._quantizationParameters);return this},_isFractionalOffsetAllowed:function(){return null==this.version||10.1<=this.version||navigator.languages&&this._isLangWithDot(navigator.languages[0])},_isLangWithDot:function(a){a=
(a=a&&a.split("-"))&&a[0]&&a[0].toLowerCase();return-1!==c.indexOf(this._langsWithDot,a)},_langsWithDot:"ar en et fr he ja ko th vi zh".split(" "),setAutoGeneralize:function(a){this.loaded?this.isEditable()||this.mode===C.MODE_SNAPSHOT||"esriGeometryPolyline"!==this.geometryType&&"esriGeometryPolygon"!==this.geometryType&&!this.hasXYFootprint()||((this._autoGeneralize=a)?(this._autoSnapshot&&(this._prevScale=null),this._updateMaxOffset()):this._setMaxOffset(null)):this._optAutoGen=a;return this},
setGDBVersion:function(a){this._collection||a===this.gdbVersion||!a&&!this.gdbVersion||(this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=q.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange());return this},hasAllFeatures:function(){return this._mode?this._mode.hasAllFeatures():!0},setDefinitionExpression:function(a){this._defnExpr=a;(a=this._mode)&&a.propertyChangeHandler(1);return this},getDefinitionExpression:function(){return this._defnExpr},
setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=a;this._timeOffsetUnits=b;var c=this._mode;c&&c.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=
a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,b,c,d){b=b||C.SELECTION_NEW;this._hasPartialSelectedFeatures=!1;a=this._getShallowClone(a);var h=this._map,n,e=this,f=z._fixDfd(new x(z._dfdCanceller));a.outFields=this.getOutFields();a.returnGeometry=!0;a.multipatchOption=this.multipatchOption;h&&(a.outSpatialReference=new J(h.spatialReference.toJson()));if(!this._applyQueryFilters(a,!0))return n={features:[]},this._selectHandler(n,b,c,d,f),
f;if(h=this._canDoClientSideQuery(a))f._pendingDfd=l(this._doQuery(a,h)),f._pendingDfd.then(function(a){n={features:a};e._selectHandler(n,b,c,d,f)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,d,f,!0),f;if(this.loaded&&!this.isQueryable())return this._resolve([Error("Layer does not support query capability.")],null,d,f,!0),f;var y=this;this._ts&&(a._ts=(new Date).getTime());(f._pendingDfd=this._task.execute(a)).addCallbacks(function(a){y._selectHandler(a,
b,c,d,f)},function(a){y._hasPartialSelectedFeatures=!0;y._resolve([a],null,d,f,!0)})}return f},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=this._selectedFeatures,c=this._mode,h;for(h in b)b.hasOwnProperty(h)&&(this._unSelectFeatureIIf(h,c),c._removeFeatureIIf(h));this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=
a){var b=this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;this._collection&&(this._typesDirty=!0);this.onLabelingInfoChange()},_fixLabelExpr:function(){var a=/\[([^\[\]]+)\]/ig,b,d=this,e=function(a,b){var c=d._getField(b,!0);return"["+(c&&c.name||b)+"]"};c.forEach(this.labelingInfo,function(c){if(b=c.labelExpression)c.labelExpression=
b.replace(a,e)})},_updateRequiredFieldsFromLabelingInfo:function(){var a=[];c.forEach(this.labelingInfo,function(b){var h=b.labelExpressionInfo;if(b.labelExpression){var d=/[\[\]]/ig;b=b.labelExpression.match(/\[[^\[\]]+\]/ig);(b=c.map(b,function(a){return a.replace(d,"")}))&&(a=a.concat(b))}if(h){if(h.value){var n=/[\{\}]/ig;b=h.value.match(/\{[^\{\}]+\}/ig);(b=c.map(b,function(a){return a.replace(n,"")}))&&(a=a.concat(b))}h.expression&&(a=a.concat(U.extractFieldNames(h.expression)))}});a=c.map(a,
function(a){var b=this.getField(a);return b?b.name:a},this);this._requiredFields&&(this._requiredFields=this._requiredFields.concat(a))},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,b,d,e,f,g){var h=g.assembly,n=g.dfd;this._applyNormalized(a,h&&h[0]);this._applyNormalized(b,h&&h[1]);this.onBeforeApplyEdits(a,b,d);var y={},k=this.objectIdField,h={f:"json"},E=!1;if(this._collection)g={},g.addResults=a?c.map(a,function(){E=!0;return{objectId:this._nextId++,success:!0}},
this):null,g.updateResults=b?c.map(b,function(a){E=!0;var b=a.attributes[k];y[b]=a;return{objectId:b,success:!0}},this):null,g.deleteResults=d?c.map(d,function(a){E=!0;return{objectId:a.attributes[k],success:!0}},this):null,E?this._editHandler(g,a,y,e,f,n):this._resolve([g.addResults,g.updateResults,g.deleteResults],null,e,n);else{a&&0<a.length&&(h.adds=this._convertFeaturesToJson(a,0,1),E=!0);if(b&&0<b.length){for(g=0;g<b.length;g++){var l=b[g];y[l.attributes[k]]=l}h.updates=this._convertFeaturesToJson(b,
0,0,1);E=!0}if(d&&0<d.length){b=[];for(g=0;g<d.length;g++)b.push(d[g].attributes[k]);h.deletes=b.join(",");E=!0}if(E){var Q=this;return p({url:this._url.path+"/applyEdits",content:q.mixin(h,this._url.query),callbackParamName:"callback",load:function(b){Q._editHandler(b,a,y,e,f,n)},error:function(a){Q._resolve([a],null,f,n,!0)}},{usePost:!0})}this._resolve([],null,e,n)}},queryFeatures:function(a,b,c){return this._query("execute","onQueryFeaturesComplete",a,b,c)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery",
"onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c){return this._query("executeForIds","onQueryIdsComplete",a,b,c)},queryCount:function(a,b,c){return this._query("executeForCount","onQueryCountComplete",a,b,c)},queryExtent:function(a,b,c){return this._query("executeForExtent","onQueryExtentComplete",a,b,c)},queryAttachmentInfos:function(a,d,e){var h=this._url.path+"/"+a+"/attachments",n=new x(z._dfdCanceller),f=this;n._pendingDfd=p({url:h,content:q.mixin({f:"json"},this._url.query),
callbackParamName:"callback",load:function(e){e=e.attachmentInfos;var g;c.forEach(e,function(c){g=b.objectToQuery({gdbVersion:f._url.query&&f._url.query.gdbVersion,layer:f._url.query&&f._url.query.layer,token:f._getToken()});c.url=h+"/"+c.id+(g?"?"+g:"");c.objectId=a});f._resolve([e],"onQueryAttachmentInfosComplete",d,n)},error:function(a){f._resolve([a],null,e,n,!0)}});return n},addAttachment:function(a,b,c,d){return this._sendAttachment("add",a,b,c,d)},updateAttachment:function(b,c,d,e,f){d.appendChild(a.create("input",
{type:"hidden",name:"attachmentId",value:c}));return this._sendAttachment("update",b,d,e,f)},deleteAttachments:function(a,b,d,e){var h=this._url.path+"/"+a+"/deleteAttachments",n=new x(z._dfdCanceller),f=this;b={f:"json",attachmentIds:b.join(",")};n._pendingDfd=p({url:h,content:q.mixin(b,this._url.query),callbackParamName:"callback",load:q.hitch(this,function(b){b=b.deleteAttachmentResults;b=c.map(b,function(b){b=new G(b);b.attachmentId=b.objectId;b.objectId=a;return b});f._resolve([b],"onDeleteAttachmentsComplete",
d,n)}),error:function(a){f._resolve([a],null,e,n,!0)}},{usePost:!0});return n},addType:function(a){var b=this.types;if(b){if(c.some(b,function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var h=-1;c.some(b,function(b,c){return b.id==a?(h=c,!0):!1});if(-1<h)return this._typesDirty=!0,b.splice(h,1)[0]}}},toJson:function(){var a=this._json;if(a=q.isString(a)?A.fromJson(a):q.clone(a)){var a=
a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,d=this._collection;if(d&&this._typesDirty){b.types=c.map(this.types||[],function(a){return a.toJson()});var e=this.renderer,f=this.labelingInfo,g=b.drawingInfo;!e&&!f||g||(g=b.drawingInfo={});g&&e&&-1===e.declaredClass.indexOf("TemporalRenderer")&&(g.renderer=e.toJson());f&&(g.labelingInfo=c.map(f,function(a){return a.toJson()}))}e=null;if(!d||this._fcAdded)e={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,
!0)};a.featureSet=q.mixin({},a.featureSet||{},e);a.featureSet.transform&&(f=a.featureSet.transform,delete a.featureSet.transform,e=new I(a.featureSet),e.quantize(f),a.featureSet=e.toJson());d&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},
onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},_forceIdentity:function(a){var b=this,c,h=this._url&&this._url.path;c=h&&h.toLowerCase().indexOf("/rest/services");var d=this.editFieldsInfo,
d=d&&(d.creatorField||d.editorField);(this.userIsAdmin||d)&&!this._getToken()&&-1<c&&f.id?(c=h.substring(0,c)+"/rest/info",p({url:c,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(function(a){if(a.owningSystemUrl)return f.id.checkSignInStatus(a.owningSystemUrl+"/sharing")}).then(function(a){if(a)return f.id.getCredential(h)}).then(function(a){a&&b._findCredential()}).always(function(){a.call(b)})):a.call(this)},_checkMode:function(a){var b=this.geometryType,c=this.maxRecordCount;
a=(a=a&&a.features&&a.features[0])&&a.attributes&&a.attributes.exceedslimit;this.mode===C.MODE_AUTO&&!this.isEditable()&&0===a&&(this.queryPagination||("esriGeometryPolyline"===b||"esriGeometryPolygon"===b||"esriGeometryMultipoint"===b||this.hasXYFootprint())&&c>=this.maxRecordCountForAuto||"esriGeometryPoint"===b&&c>=this.maxPointCountForAuto)&&(this.currentMode=C.MODE_SNAPSHOT,this._mode=new L(this),this._isSnapshot=this._autoSnapshot=!0)},_queryLimit:function(){var a=this,b=new x;this._limitPromise=
b.promise;setTimeout(function(){var c=new K,h=new W;h.statisticType="exceedslimit";h.maxPointCount=a.maxPointCountForAuto;h.maxRecordCount=a.maxRecordCountForAuto;h.maxVertexCount=a.maxVertexCountForAuto;h.outStatisticFieldName="exceedslimit";c.outStatistics=[h];a.queryFeatures(c).promise.then(function(a){b.resolve(a)},function(a){b.reject(a)})},0)},_updateCaps:function(){var a=this._editable,b=q.trim(this.capabilities||""),d=c.map(b?b.split(","):[],q.trim),e=c.map(b?b.toLowerCase().split(","):[],
q.trim),b=c.indexOf(e,"editing"),f,e={Create:c.indexOf(e,"create"),Update:c.indexOf(e,"update"),Delete:c.indexOf(e,"delete")};if(a&&-1===b)d.push("Editing");else if(!a&&-1<b){a=[b];for(f in e)-1<e[f]&&a.push(e[f]);a.sort();for(f=a.length-1;0<=f;f--)d.splice(a[f],1)}this.capabilities=d.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);
this._toggleTime(!0);var b=this._mode,c=this._map,h=this._getRenderer();a.firstOccurrence?(this._fixRendererFields(),this._updateRequiredFieldsFromLabelingInfo(),this._checkFields(),this.clearSelection(),this.timeInfo&&!this._trackManager&&(this._trackIdField||h&&(h.latestObservationRenderer||h.trackRenderer))&&(this._trackManager=new O(this),this._trackManager.initialize(c),this._childLayer=this._trackManager.container),h&&"colors"in h&&"blurRadius"in h&&"maxPixelIntensity"in h&&"esriGeometryPoint"==
this.geometryType&&!this._heatmapManager&&(this._heatmapManager=new P(this),this._heatmapManager.initialize(c)),this._autoSnapshot&&this._autoGeneralize&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint())&&!this.isEditable()&&null==this.getMaxAllowableOffset()&&(h=this.generalizeForScale,this._calculatedScale=h=this.maxScale?this.maxScale:this.minScale?Math.min(h,this.minScale):Math.min(h,Z.getScale(c,this.initialExtent)),this._calcMaxOffset=
c.extent.getWidth()/c.width/c.getScale()*h),this._zoomConnect=w.connect(c,"onZoomEnd",this,this._zoomEndHandler),this._updateMaxOffset(),this._needsRefresh=!1,b&&b.startup()):(this._zoomEndHandler(),b&&b.resume())},_zoomEndHandler:function(){var a=this._map;this._updateMaxOffset();this._prevScale=a.getScale();!this.suspended&&this._needsRefresh&&this.refresh()},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._autoSnapshot?(a=this.getMaxAllowableOffset(),this._setMaxOffset(this._getMaxOffsetForScale(),
!0),this._needsRefresh||(this._needsRefresh=a!=this.getMaxAllowableOffset())):this._setMaxOffset(a.extent.getWidth()/a.width,!a.extent.spatialReference.isWebMercator()))},_getMaxOffsetForScale:function(){if(this._map){var a=this._map.getScale(),b=this._calculatedScale,c=this._calcMaxOffset,d=this._prevScale;return a>=b&&(null==d||d<b)?c:a<b&&(null==d||d>=b)?null:this.getMaxAllowableOffset()}},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,
this._timeConnect||(this._timeConnect=w.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,w.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),
c;if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=this.getDefinitionExpression();return a?b?"("+b+") AND ("+a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.maxAllowableOffset||(a.maxAllowableOffset=this._maxOffset);a.quantizationParameters=this._quantizationParameters;b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields());
if(this.timeInfo){var c=this._getTimeFilter(a.timeExtent);if(c[0])a.timeExtent=c[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,d=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(d&&c&&c.hasOwnProperty(d))a[c[d]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var b=[],d=this._map,h;if((this._collection||!this._isTable&&d)&&!(a.text||a.where&&a.where!==
this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length&&(h=this.getOrderByFields()||[])&&a.orderByFields.join()!==h.join()||a.outStatistics||a.returnDistinctValues)){h=this._isSnapshot;var e=this._isSelOnly,f=a.geometry;if(f){if(e||a.spatialRelationship!==K.SPATIAL_REL_INTERSECTS||"extent"!==f.type||!h&&!d.extent.contains(f))return;b.push(1)}if(d=a.objectIds)if(h)b.push(2);else{var f=d.length,g=this._mode,k=0,l;for(l=0;l<f;l++)g._getFeature(d[l])&&k++;if(k===f)b.push(2);else return}if(this.timeInfo)if(a=
a.timeExtent,d=this._mapTimeExtent,h)a&&b.push(3);else if(e){if(a)return}else if(d)if(-1!==c.indexOf(b,2))a&&b.push(3);else if(-1!==c.indexOf(b,1))a==d&&b.push(3);else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:null}},_getAbsMid:function(a){return d.toAbsMid?d.toAbsMid(a):m.id.replace(/\/[^\/]*$/ig,"/")+a},_doQuery:function(a,b,d){var h=[],e=this.objectIdField,f=this,g=new x,n=new x,k=this.graphics;if(-1!==c.indexOf(b,1)){var l=this.spatialIndex||this._map&&this._map.spatialIndex,
y,m=a.geometry._normalize(null,!0);null==l&&ka.autoSpatialIndexing?y=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(q.hitch(this,q.partial(this._getFromIndex,m,l)),function(a){n.resolve(q.hitch(this,q.partial(this._filterByExtent,k,m)))}):l&&(y=this._getFromIndex(m,l));y?y.then(function(a){for(var b=0;b<a.length;b++)a[b].results&&(h=h.concat(a[b].results));n.resolve(h)}).otherwise(function(a){n.reject(a)}):n.resolve(this._filterByExtent(k,m))}else n.resolve(k);n.then(function(n){h=
n;if(-1!==c.indexOf(b,2)){var k=a.objectIds;h=c.filter(h,function(a){return-1<c.indexOf(k,a.attributes[e])})}-1!==c.indexOf(b,3)&&f.timeInfo&&(n=a.timeExtent,h=f._filterByTime(h,n.startTime,n.endTime).match);d&&(h=c.map(h,function(a){return a.attributes[e]},this));g.resolve(h)});return g},_getFromIndex:function(a,b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var d=this.id;return v(c.map(a,function(a){return b.intersects(a,d)}))},_filterByExtent:function(a,b){for(var c=
[],d=0,h=a.length;d<h;d++){var e=a[d],f=e.geometry;f&&(this.normalization&&b.length?(b[0].intersects(f)||b[1].intersects(f))&&c.push(e):b.intersects(f)&&c.push(e))}return c},_filterByTime:function(a,b,c){var d=this._startTimeField,h=this._endTimeField,e;this._twoTimeFields||(e=d||h);var f=g.isDefined,k=[],n=[],l,m=a.length,y,q;b=b?b.getTime():-Infinity;c=c?c.getTime():Infinity;if(e)for(l=0;l<m;l++)y=a[l],q=y.attributes,d=q[e],d>=b&&d<=c?k.push(y):n.push(y);else for(l=0;l<m;l++)y=a[l],q=y.attributes,
e=q[d],q=q[h],e=f(e)?e:-Infinity,q=f(q)?q:Infinity,e>=b&&e<=c||q>=b&&q<=c||b>=e&&c<=q?k.push(y):n.push(y);return{match:k,noMatch:n}},_getSizeVariables:function(a){return a&&c.filter(a.getVisualVariablesForType("sizeInfo",!1),function(a){return!(!a.field&&!a.valueExpression)})},_needClientSideSorting:function(a){return this._collection?!(!a||!a.length):c.some(a,function(a){return!!a.valueExpression})},_sortFeatures:function(a){var b=this.renderer,c=this._getSizeVariables(b);if(a&&1<a.length&&this._needClientSideSorting(c)){var d=
c[0],h=this;a.sort(function(a,c){a._layer||(a._layer=h);c._layer||(c._layer=h);var e=b._getDataValue(a,d,"sizeInfo",null,h),f=b._getDataValue(c,d,"sizeInfo",null,h);return null==e?-1:null==f?1:f-e})}return a},_resolve:function(a,b,c,d,e){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&z._resDfd(d,a,e)},_getShallowClone:function(a){var b=new K,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_query:function(a,b,d,e,f){var h=this,g=this._map,k=new x(z._dfdCanceller),n=d,m,q;if("executeRelationshipQuery"!==
a){var n=this._getShallowClone(d),y=this.getOutFields();n.outFields||(n.outFields=y);n.outFields&&n.outFields.length&&(q=-1<c.indexOf(y,"*")?!1:!c.every(n.outFields,function(a){return-1<c.indexOf(y,a)}));n.returnGeometry=d.hasOwnProperty("returnGeometry")?d.returnGeometry:!d.outStatistics;n.returnGeometry&&(n.multipatchOption=this.multipatchOption);var p;g&&(d=g&&g.spatialReference,(g=n.outSpatialReference)?m=!g.equals(d):n.outSpatialReference=new J(d.toJson()));if(!this._applyQueryFilters(n,"execute"===
a&&!n.outStatistics)){switch(a){case "execute":p=new I({features:[]});break;case "executeForIds":p=[];break;case "executeForCount":p=0;break;case "executeForExtent":p={}}this._resolve([p],b,e,k);return k}if(d="executeForExtent"!==a&&!m&&!q&&this._canDoClientSideQuery(n))return k._pendingDfd=l(this._doQuery(n,d,"executeForIds"===a||"executeForCount"===a)),k._pendingDfd.then(function(c){switch(a){case "execute":p=new I;p.features=c;break;case "executeForIds":p=c;break;case "executeForCount":p=c.length}h._resolve([p],
b,e,k)}),k}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,f,k,!0),k;if(this.loaded&&!this.isQueryable())return this._resolve([Error("Layer does not support query capability.")],null,f,k,!0),k;this._ts&&(n._ts=(new Date).getTime());(k._pendingDfd=this._task[a](n)).addCallbacks(function(c){var d=!!n.outStatistics||m||q;if("execute"===a||"executeRelationshipQuery"===a){var f,g;if("execute"===a)for(f=c.features,g=f.length,--g;0<=g;g--){if(f[g]._layer=
h,!d&&!h._isTable){var l=h._mode._getFeature(f[g].attributes[h.objectIdField]);l&&f.splice(g,1,l)}}else for(l in c)if(c.hasOwnProperty(l))for(f=c[l].features,g=f.length,--g;0<=g;g--)f[g]._layer=h}h._resolve([c],b,e,k)},function(a){h._resolve([a],null,f,k,!0)});return k},_convertFeaturesToJson:function(a,b,d,e){var h=[],f=this._selectionSymbol,g=this.visibilityField,k,n=this.objectIdField;this.loaded&&(d||e)&&(k=c.filter(this.fields,function(a){return!1===a.editable&&(!e||a.name!==n)}));for(d=0;d<
a.length;d++){var l=a[d],m={},p=l.geometry,y=l.attributes,r=l.symbol;!p||e&&this.loaded&&!this.allowGeometryUpdates||(m.geometry=p.toJson());g?(m.attributes=y=q.mixin({},y),y[g]=l.visible?1:0):y&&(m.attributes=q.mixin({},y));m.attributes&&k&&k.length&&c.forEach(k,function(a){delete m.attributes[a.name]});r&&r!==f&&(m.symbol=r.toJson());h.push(m)}return b?h:A.toJson(h)},_selectHandler:function(a,b,c,d,e){var h;d=C;switch(b){case d.SELECTION_NEW:this.clearSelection(!0);h=!0;break;case d.SELECTION_ADD:h=
!0;break;case d.SELECTION_SUBTRACT:h=!1}d=a.features;var f=this._mode,g=[],k=this.objectIdField,n,l;if(h)for(h=0;h<d.length;h++)n=d[h],l=n.attributes[k],n=f._addFeatureIIf(l,n),g.push(n),this._selectFeatureIIf(l,n,f);else for(h=0;h<d.length;h++)n=d[h],l=n.attributes[k],this._unSelectFeatureIIf(l,f),l=f._removeFeatureIIf(l),g.push(l||n);this._isSelOnly&&f._applyTimeFilter(!0);this._hasPartialSelectedFeatures=!!a.exceededTransferLimit;this._resolve([g,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:
null],"onSelectionComplete",c,e);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var d=this._selectedFeatures,e=d[a];e||(c._incRefCount(a),d[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return e||b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),c.attr("data-selected")));return c},_isSelected:function(a){},_setSelectSymbol:function(a){var b=
this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._requiredFields).concat(this.dataAttributes),a=c.filter(a,function(a,b,d){return!!a&&c.indexOf(d,a)===b}),b=q.clone(this._outFields);if(b){if(-1!==c.indexOf(b,"*"))return b;
c.forEach(a,function(a){-1===c.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();c.forEach(b,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+g.substitute({url:this.url,field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);a||this._isTable||this._fserver||this._collection||this._isStream||c.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||
console.debug("esri.layers.FeatureLayer: "+g.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]"))},_fixFieldCase:function(a,b,c){var d=a&&a[b],e;if(d&&!q.isFunction(d)){if(e=!this._getField(d)&&this._getField(d,!0))d=a[b]=e.name;c&&c.push(d)}return d},_fixRendererFields:function(){var a=this.renderer;this._orderBy=null;this._requiredFields=[];if(a&&
0<this.fields.length){var b=[],d,a=c.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],g.isDefined),e=[].concat(a);c.forEach(a,function(a){c.forEach(a.rendererInfos,function(a){a.renderer&&e.push(a.renderer)})});c.forEach(e,function(a){this._fixFieldCase(a,"attributeField",b);this._fixFieldCase(a,"attributeField2",b);this._fixFieldCase(a,"attributeField3",b);this._fixFieldCase(a.rotationInfo,"field",b);(d=this._fixFieldCase(a.sizeInfo,"field",b))&&!this._orderBy&&(this._orderBy=
[d+" DESC"]);this._fixFieldCase(a.sizeInfo,"normalizationField",b);this._fixFieldCase(a.colorInfo,"field",b);this._fixFieldCase(a.colorInfo,"normalizationField",b);this._fixFieldCase(a.field,"field",b);this._fixFieldCase(a.opacityInfo,"field",b);this._fixFieldCase(a.opacityInfo,"normalizationField",b);c.forEach(a.visualVariables,function(a){d=this._fixFieldCase(a,"field",b);"sizeInfo"===a.type&&d&&!this._orderBy&&(this._orderBy=[d+" DESC"]);this._fixFieldCase(a,"normalizationField",b)},this);var e=
c.map(a.getFieldsUsedInExpressions(),function(a){var b=this.getField(a);return b?b.name:a},this);b=b.concat(e);this._orderBy||!a.addBreak||q.isFunction(a.attributeField)||!a.backgroundFillSymbol&&!this._hasSizeDiff(a)||(this._orderBy=[a.attributeField+" DESC"])},this);this._requiredFields=c.filter(b,g.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,d=-Number.MAX_VALUE,e,f;c.forEach(a.infos,function(a){if(f=a.symbol){e=0;switch(f.type){case "simplemarkersymbol":e=f.size;break;case "picturemarkersymbol":e=
(f.width+f.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":e=f.width;break;case "simplefillsymbol":case "picturefillsymbol":e=f.outline&&f.outline.width}e&&(b=Math.min(b,e),d=Math.max(d,e))}});return b!==Number.MAX_VALUE&&d!==-Number.MAX_VALUE&&1<Math.abs(d-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&a?c.filter(a,function(a){a=a.split(" ")[0];return!!this._getField(a,!0)},this):null},_getField:function(a,b){var d=
this.fields;if(!d||0===d.length)return null;var e;b&&(a=a.toLowerCase());c.some(d,function(c){var d=!1;(d=b?c&&c.name.toLowerCase()===a?!0:!1:c&&c.name===a?!0:!1)&&(e=c);return d});return e},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:c.map(c.filter(this.fields,function(a){return!(!a||"esriFieldTypeDate"!==a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&c.forEach(a,function(a,c){a&&b[c]&&a.setGeometry(b[c])})},_editHandler:function(a,
b,d,e,f,g){f=a.addResults;var h=a.updateResults;a=a.deleteResults;var k,l,n,m,p,r=this.objectIdField,t=this._mode,u=this._isTable;k=this.editFieldsInfo;m=this.getOutFields()||[];var v=k&&k.creatorField,w=k&&k.creationDateField,x=k&&k.editorField,y=k&&k.editDateField;k=k&&k.realm;-1===c.indexOf(m,"*")&&(v&&-1===c.indexOf(m,v)&&(v=null),w&&-1===c.indexOf(m,w)&&(w=null),x&&-1===c.indexOf(m,x)&&(x=null),y&&-1===c.indexOf(m,y)&&(y=null));var z=w||y?(new Date).getTime():null,A=v||x?this.getUserId():void 0;
A&&k&&(A=A+"@"+k);if(f){var B=this.globalIdField;for(k=0;k<f.length;k++)f[k]=new G(f[k]),u||(l=f[k],l.success&&(n=l.objectId,m=b[k],(p=m._graphicsLayer)&&p!==this&&p.remove(m),p=m.attributes||{},p[r]=n,n=l.globalId,B&&n&&(p[B]=n),v&&(p[v]=A),x&&(p[x]=A),w&&(p[w]=z),y&&(p[y]=z),m.setAttributes(p),t._init&&t.drawFeature(m)))}if(h)for(k=0;k<h.length;k++)if(h[k]=new G(h[k]),!u&&(l=h[k],l.success)){n=l.objectId;m=d[n];if(b=t._getFeature(n))b.geometry!==m.geometry&&m.geometry&&b.setGeometry(X.fromJson(m.geometry.toJson())),
b.attributes!==m.attributes&&m.attributes&&b.setAttributes(q.mixin(b.attributes,m.attributes)),this._repaint(b,n);m=b||m;p=m.attributes||{};x&&(p[x]=A);y&&(p[y]=z);m.setAttributes(p)}if(a){d=[];for(k=0;k<a.length;k++)if(a[k]=new G(a[k]),!u&&(l=a[k],l.success&&(n=l.objectId,m=t._getFeature(n))))this._unSelectFeatureIIf(n,t)&&d.push(m),m._count=0,t._removeFeatureIIf(n);if(0<d.length)this.onSelectionComplete(d,C.SELECTION_SUBTRACT)}this._resolve([f,h,a],"onEditsComplete",e,g)},_sendAttachment:function(a,
b,c,d,e){var f=this;return p({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:c,content:q.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(c){var e="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";c=new G(c["add"===a?"addAttachmentResult":"updateAttachmentResult"]);c.attachmentId=c.objectId;c.objectId=b;f._resolve([c],e,d);return c}).addErrback(function(a){f._resolve([a],
null,e,null,!0)})},_repaint:function(a,b,c){b=g.isDefined(b)?b:a.attributes[this.objectIdField];b in this._selectedFeatures&&this._selectionSymbol||a.setSymbol(a.symbol,c)},_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});q.mixin(C,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});
Y._createWrappers(C);u("extend-esri")&&q.setObject("layers.FeatureLayer",C,f);return C});